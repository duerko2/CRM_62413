@page "/contacts"
@using System.Security.Claims
@using BlazorApp.Models
@using RolesAndPermissions
@inject Services.ContactService ContactService
@inject IPermissions Permissions;



<PageTitle>Contacts</PageTitle>

<h1>Contacts</h1>

@if (contacts == null || !contacts.Any())
{
    <p>No contacts available.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th @onclick="@(() => SortContacts(nameof(Contact.Name)))">
                    Company Name @SortIndicator(nameof(Contact.Name))
                </th>
                <th @onclick="@(() => SortContacts(nameof(Contact.Type)))">
                    Type @SortIndicator(nameof(Contact.Type))
                </th>
                <th @onclick="@(() => SortContacts(nameof(Contact.Company)))">
                    Company @SortIndicator(nameof(Contact.Company))
                </th>
                <th @onclick="@(() => SortContacts(nameof(Contact.VAT)))">
                    VAT @SortIndicator(nameof(Contact.VAT))
                </th>
                @if(Permissions.HasPermission(AuthenticationStateTask.Result.User, "ViewAllContacts"))
                {
                    <th @onClick="@(() => SortContacts("SalesRep"))">
                        Sales Rep @SortIndicator("SalesRep"))
                    </th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var contact in contacts)
            {
                <tr>
                    <td>
                        <NavLink href="@($"/contacts/{contact.Id}")">
                            @contact.Name
                        </NavLink>
                    </td>
                    <td>@contact.Type.ToString()</td>
                    <td>@contact.Company</td>
                    <td>@contact.VAT</td>
                    @if(Permissions.HasPermission(AuthenticationStateTask.Result.User, "ViewAllContacts"))
                    {
                    <td>@contact.RepName</td>
                    }
                </tr>
            }
        </tbody>
    </table>
}

<style>
    th {
        cursor: pointer;
        user-select: none;
    }

        th span {
            margin-left: 5px;
        }

        th:hover {
            text-decoration: underline;
        }
</style>

@code {
    private List<ContactListRow> contacts;
    private string currentSortColumn = nameof(Contact.Id);
    private bool ascending = true;
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; }

    protected override async void OnInitialized()
    {
        var authState = await AuthenticationStateTask;
        var user = authState.User;
        var userId = user.FindFirst(ClaimTypes.NameIdentifier);
        var userIdInt = userId == default ? default : int.Parse(userId.Value);
        if (userIdInt == 0 )
        {
            Console.WriteLine("User not found");
            return;
        }
        bool loadAllContacts = Permissions.HasPermission(user, "ViewAllContacts");
        if (loadAllContacts)
        {
            await LoadAllContacts(userIdInt);
        }
        else if(Permissions.HasPermission(user, "ViewOwnContacts"))
        {
            await LoadContacts(userIdInt);
        }
        SortContacts(currentSortColumn);
        StateHasChanged();
    }

    private async Task LoadAllContacts(int userId)
    {
        contacts = ContactService.GetContactsForCompany(userId);
    }
    
    private async Task LoadContacts(int userId)
    {
        contacts = ContactService.GetContacts(userId);
    }

    private void SortContacts(string columnName)
    {
        if (currentSortColumn == columnName)
        {
            // Toggle sort order if the same column is clicked
            ascending = !ascending;
        }
        else
        {
            // Sort new column ascending by default
            currentSortColumn = columnName;
            ascending = true;
        }

        // LINQ to sort the contacts
        contacts = contacts.OrderBy(contact => GetSortValue(contact, currentSortColumn)).ToList();

        if (!ascending)
        {
            contacts.Reverse();
        }
    }

    private object GetSortValue(ContactListRow contact, string columnName)
    {
        return columnName switch
        {
            nameof(Contact.Name) => contact.Name,
            nameof(Contact.Type) => contact.Type,
            nameof(Contact.Id) => contact.Id,
            _ => contact.Id
        };
    }

    private MarkupString SortIndicator(string columnName)
    {
        if (currentSortColumn != columnName)
        {
            return new MarkupString("");
        }

        var arrow = ascending ? "&#9650;" : "&#9660;"; // Up or down arrow
        return new MarkupString($"<span>{arrow}</span>");
    }
}
